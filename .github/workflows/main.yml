name: Build XZP Hybrid Kernel (NFC Fixed - Minimal + AOSP prebuilts)

on:
  workflow_dispatch:

concurrency:
  group: xzp-nfc-build
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Maximize Build Space (清理空间)
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'
        remove-haskell: 'true'
        remove-docker-images: 'true'

    - name: Show Disk (before)
      run: |
        set -e
        echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
        df -h
        echo "== largest dirs in / =="
        sudo du -xhd1 / 2>/dev/null | sort -h | tail -n 20 || true

    - name: Install Dependencies
      run: |
        set -e
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf \
          lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool \
          libncurses5 libncurses5-dev libssl-dev libxml2 libxml2-utils \
          lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          python3 python-is-python3

    - name: Install Repo Tool
      run: |
        set -e
        mkdir -p ~/bin
        curl -L https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        echo "GIT_TERMINAL_PROMPT=0" >> $GITHUB_ENV

    - name: Prepare workspace directory (强制用大盘挂载点)
      run: |
        set -e
        mkdir -p "$GITHUB_WORKSPACE/lineage"
        echo "WORKDIR=$GITHUB_WORKSPACE/lineage" >> $GITHUB_ENV
        echo "WORKDIR=$GITHUB_WORKSPACE/lineage"
        df -h "$GITHUB_WORKSPACE" || true

    - name: Create local manifest git repo (minimal.xml)
      run: |
        set -e
        cd "$WORKDIR"

        rm -rf manifest-repo
        mkdir -p manifest-repo
        cd manifest-repo
        git init -b main

        cat > minimal.xml <<'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remote name="los"  fetch="https://github.com/LineageOS/" />
          <remote name="gh"   fetch="https://github.com/" />
          <remote name="aosp" fetch="https://android.googlesource.com/" />

          <default remote="los" revision="lineage-22.0" />

          <!-- ✅ LOS 22 构建骨架（有 lineage-22.0 分支的那部分） -->
          <project name="android_build" path="build" />
          <project name="android_build_soong" path="build/soong" />
          <project name="android_system_core" path="system/core" />
          <project name="android_system_sepolicy" path="system/sepolicy" />
          <project name="android_frameworks_base" path="frameworks/base" />

          <!-- ✅ AOSP upstream：这些仓库经常没有 lineage-22.0 分支，改用 googlesource main -->
          <project name="platform/external/libcxx"
                   path="external/libcxx"
                   remote="aosp"
                   revision="main" />
          <project name="platform/external/zlib"
                   path="external/zlib"
                   remote="aosp"
                   revision="main" />

          <project name="platform/prebuilts/build-tools"
                   path="prebuilts/build-tools"
                   remote="aosp"
                   revision="main" />
          <project name="platform/prebuilts/tools"
                   path="prebuilts/tools"
                   remote="aosp"
                   revision="main" />
          <project name="platform/prebuilts/clang/host/linux-x86"
                   path="prebuilts/clang/host/linux-x86"
                   remote="aosp"
                   revision="main" />

          <!-- ✅ 你的混合来源：LOS21 kernel + device + common -->
          <project name="whatawurst/android_kernel_sony_msm8998"
                   path="kernel/sony/msm8998"
                   remote="gh"
                   revision="lineage-21" />

          <!-- ✅ 关键修复：maple 的 device tree 用 whatawurst 的仓库，不用 LineageOS 组织仓库 -->
          <project name="whatawurst/android_device_sony_maple"
                   path="device/sony/maple"
                   remote="gh"
                   revision="lineage-21" />

          <project name="whatawurst/android_device_sony_yoshino-common"
                   path="device/sony/yoshino-common"
                   remote="gh"
                   revision="lineage-21" />
        </manifest>
        EOF

        git add minimal.xml
        git commit -m "Add minimal manifest" >/dev/null

        echo "== minimal.xml =="
        cat minimal.xml

    - name: Init Repo (Minimal)
      run: |
        set -e
        cd "$WORKDIR"
        repo init -u "$WORKDIR/manifest-repo" -b main -m minimal.xml \
          --depth=1 \
          --partial-clone \
          --clone-filter=blob:none

    - name: Repo Sync (fail-fast)
      run: |
        set -euo pipefail
        cd "$WORKDIR"
        echo "== repo sync =="
        repo sync -c -j1 --fail-fast --force-sync --no-clone-bundle --no-tags --optimized-fetch --prune

    - name: Show Disk (after sync)
      run: |
        set -e
        cd "$WORKDIR"
        df -h
        du -sh .repo || true
        du -sh . || true

    - name: Patch defconfig (enable CXD224X, disable PN553)
      run: |
        set -euo pipefail
        cd "$WORKDIR"

        CANDIDATES=(
          "kernel/sony/msm8998/arch/arm64/configs/lineage_yoshino_defconfig"
          "kernel/sony/msm8998/arch/arm64/configs/yoshino_defconfig"
          "kernel/sony/msm8998/arch/arm64/configs/lineage_defconfig"
        )

        CONFIG_FILE=""
        for f in "${CANDIDATES[@]}"; do
          if [ -f "$f" ]; then CONFIG_FILE="$f"; break; fi
        done

        if [ -z "$CONFIG_FILE" ]; then
          echo "❌ defconfig not found"
          ls -la kernel/sony/msm8998/arch/arm64/configs || true
          exit 1
        fi

        set_kcfg() {
          local key="$1" val="$2" file="$3"
          if grep -qE "^${key}=" "$file"; then
            sed -i "s/^${key}=.*/${key}=${val}/" "$file"
          else
            echo "${key}=${val}" >> "$file"
          fi
        }

        set_kcfg CONFIG_SONY_CXD224X y "$CONFIG_FILE"
        set_kcfg CONFIG_NFC_PN553 n "$CONFIG_FILE"

        echo "== defconfig result =="
        grep -nE "CONFIG_SONY_CXD224X=|CONFIG_NFC_PN553=" "$CONFIG_FILE" || true

    - name: Build Boot Image
      run: |
        set -euo pipefail
        cd "$WORKDIR"

        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export BUILD_BROKEN_MISSING_REQUIRED_MODULES=true
        export BUILD_BROKEN_ELF_PREBUILT_PRODUCT_COPY_FILES=true

        lunch lineage_maple-userdebug
        mka bootimage

        echo "== boot.img =="
        ls -la out/target/product/maple/boot.img

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fixed_boot_image_for_los22
        path: ${{ github.workspace }}/lineage/out/target/product/maple/boot.img
