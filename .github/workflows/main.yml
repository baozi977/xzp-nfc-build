name: build-imagegz-popkernel-stockconfig

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "Kernel git repo URL (Pop Kernel recommended)"
        required: true
        default: "https://github.com/linckandrea/android_kernel_sony_msm8998-EAS.git"
      kernel_branch:
        description: "Kernel branch/tag (match your running kernel: 14-r3-p)"
        required: true
        default: "14-r3-p"
      defconfig:
        description: "Fallback defconfig (only used if stock.config missing)"
        required: true
        default: ""

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Sanity check inputs/files
        run: |
          set -eux
          echo "kernel_repo=${{ inputs.kernel_repo }}"
          echo "kernel_branch=${{ inputs.kernel_branch }}"
          echo "defconfig=${{ inputs.defconfig }}"
          test -f ./build_kernel.sh
          # stock.config 推荐一定要有（没有也能跑，但可能黑屏）
          ls -lah ./stock.config || true

      - name: Install build deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex git libelf-dev libssl-dev \
            python3 unzip zlib1g-dev lz4 ca-certificates file \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

      - name: Build Image.gz (from stock.config if present)
        env:
          # 可选：如果内核仓库需要权限/你网络环境需要 token
          # 在 GitHub 仓库 Settings -> Secrets and variables -> Actions -> New repository secret
          # 名字填：KERNEL_GITHUB_TOKEN
          KERNEL_GITHUB_TOKEN: ${{ secrets.KERNEL_GITHUB_TOKEN }}
        run: |
          set -eux
          chmod +x ./build_kernel.sh

          # 你的 build_kernel.sh 需要支持：
          # - 如果仓库根目录存在 stock.config，就用它作为 out/.config 并 make olddefconfig
          # - 输出 out/Image.gz
          ./build_kernel.sh "${{ inputs.kernel_repo }}" "${{ inputs.kernel_branch }}" "${{ inputs.defconfig }}"

          test -f out/Image.gz
          ls -lah out/Image.gz
          file out/Image.gz || true

      - name: Upload Image.gz artifact
        uses: actions/upload-artifact@v4
        with:
          name: Image-gz
          path: out/Image.gz
