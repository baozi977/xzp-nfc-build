name: build-imagegz-only

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "Kernel git repo URL"
        required: true
        default: "https://github.com/whatawurst/android_kernel_sony_msm8998.git"
      kernel_branch:
        description: "Preferred kernel branch (auto-fallback if not found)"
        required: true
        default: "lineage-22.0"
      defconfig:
        description: "Kernel defconfig (optional; build_kernel.sh auto-picks if missing/wrong)"
        required: true
        default: "lineage_yoshino_defconfig"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex git libelf-dev libssl-dev \
            python3 unzip zlib1g-dev lz4 ca-certificates file \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

      # ---- Select kernel branch (auto fallback) ----
      - name: Select kernel branch (auto fallback)
        id: pick_branch
        run: |
          set -eux
          REPO="${{ inputs.kernel_repo }}"
          PREFERRED="${{ inputs.kernel_branch }}"

          pick() {
            b="$1"
            if git ls-remote --heads "$REPO" "refs/heads/$b" | grep -q "refs/heads/$b"; then
              echo "$b"
              return 0
            fi
            return 1
          }

          for b in "$PREFERRED" lineage-22 lineage-21.0 lineage-21 lineage-20.0 lineage-20 lineage-19.1 lineage-19; do
            if pick "$b" >/dev/null; then
              echo "branch=$b" >> "$GITHUB_OUTPUT"
              echo "Selected branch: $b"
              exit 0
            fi
          done

          echo "ERROR: No suitable branch found on $REPO"
          exit 1

      - name: Build Image.gz
        env:
          # 可选：如果你在仓库 Settings -> Secrets -> Actions 里设置了
          # Name: KERNEL_GITHUB_TOKEN
          KERNEL_GITHUB_TOKEN: ${{ secrets.KERNEL_GITHUB_TOKEN }}
        run: |
          set -eux
          test -f ./build_kernel.sh
          chmod +x ./build_kernel.sh

          ./build_kernel.sh "${{ inputs.kernel_repo }}" "${{ steps.pick_branch.outputs.branch }}" "${{ inputs.defconfig }}"

          test -f out/Image.gz
          ls -lah out/Image.gz
          file out/Image.gz || true

      - name: Upload Image.gz
        uses: actions/upload-artifact@v4
        with:
          name: Image-gz
          path: out/Image.gz
