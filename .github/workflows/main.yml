name: build-kernel-and-repack-boot

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "Kernel git repo URL"
        required: true
        default: "https://github.com/whatawurst/android_kernel_sony_msm8998.git"
      kernel_branch:
        description: "Preferred kernel branch (will auto-fallback if not found)"
        required: true
        default: "lineage-22.0"
      defconfig:
        description: "Kernel defconfig name (optional; build_kernel.sh will auto-pick if missing/wrong)"
        required: true
        default: "lineage_yoshino_defconfig"
      magisk_ver:
        description: "Magisk version to extract magiskboot from"
        required: true
        default: "26.4"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex git libelf-dev libssl-dev \
            python3 unzip zlib1g-dev lz4 ca-certificates file gcc \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

      # ---- Install magiskboot (Magisk 26.x: use libmagiskboot.so as executable) ----
      - name: Install magiskboot
        run: |
          set -eux
          MAGISK_VER="${{ inputs.magisk_ver }}"
          URL="https://github.com/topjohnwu/Magisk/releases/download/v${MAGISK_VER}/Magisk-v${MAGISK_VER}.apk"

          rm -rf magisk_unpack
          mkdir -p magisk_unpack

          curl -fL --retry 5 --retry-delay 2 -o magisk.apk "$URL"
          unzip -q magisk.apk -d magisk_unpack

          MB_SO="magisk_unpack/lib/x86_64/libmagiskboot.so"
          if [ ! -f "$MB_SO" ]; then
            echo "x86_64 lib not found, search any libmagiskboot.so..."
            MB_SO="$(find magisk_unpack -type f -name 'libmagiskboot.so' -print | head -n 1 || true)"
          fi

          if [ -z "$MB_SO" ] || [ ! -f "$MB_SO" ]; then
            echo "ERROR: libmagiskboot.so not found. Listing:"
            find magisk_unpack -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          chmod +x "$MB_SO"
          sudo cp "$MB_SO" /usr/local/bin/magiskboot
          sudo chmod +x /usr/local/bin/magiskboot
          magiskboot --help | head -n 15 || true

      # ---- Select kernel branch (auto fallback) ----
      - name: Select kernel branch (auto fallback)
        id: pick_branch
        run: |
          set -eux
          REPO="${{ inputs.kernel_repo }}"
          PREFERRED="${{ inputs.kernel_branch }}"

          pick() {
            b="$1"
            if git ls-remote --heads "$REPO" "refs/heads/$b" | grep -q "refs/heads/$b"; then
              echo "$b"
              return 0
            fi
            return 1
          }

          for b in "$PREFERRED" lineage-22 lineage-21.0 lineage-21 lineage-20.0 lineage-20 lineage-19.1 lineage-19; do
            if pick "$b" >/dev/null; then
              echo "branch=$b" >> "$GITHUB_OUTPUT"
              echo "Selected branch: $b"
              exit 0
            fi
          done

          echo "ERROR: No suitable branch found on $REPO"
          exit 1

      # ---- Unpack base boot first & save its kernel_dtb ----
      - name: Unpack base boot & save base kernel_dtb
        run: |
          set -eux
          test -f boot.img
          cp boot.img boot-base.img

          # Print header info (yours is HEADER_VER 0)
          magiskboot unpack -h boot-base.img

          # Unpack to get kernel / ramdisk / kernel_dtb
          magiskboot unpack boot-base.img

          # Save original kernel_dtb for reuse
          test -f kernel_dtb
          cp kernel_dtb base_kernel_dtb
          ls -lah base_kernel_dtb

      # ---- Build kernel (Image.gz + dtbs) ----
      - name: Build kernel (Image.gz + dtbs)
        env:
          # Optional: add PAT in repo Settings -> Secrets -> Actions:
          # Name: KERNEL_GITHUB_TOKEN
          KERNEL_GITHUB_TOKEN: ${{ secrets.KERNEL_GITHUB_TOKEN }}
        run: |
          set -eux
          test -f ./build_kernel.sh
          chmod +x ./build_kernel.sh

          # build_kernel.sh must output:
          #   out/Image.gz
          #   out/dtb/   (not used now, but kept for future DT work)
          ./build_kernel.sh "${{ inputs.kernel_repo }}" "${{ steps.pick_branch.outputs.branch }}" "${{ inputs.defconfig }}"

          test -f out/Image.gz
          ls -lah out/Image.gz

      # ---- Repack: replace kernel only, reuse base kernel_dtb ----
      - name: Repack boot.img (replace kernel only, reuse base kernel_dtb)
        run: |
          set -eux

          # Replace kernel with newly built Image.gz
          test -f out/Image.gz
          cp out/Image.gz kernel

          # Reuse original dtb blob (critical: avoids dtbTool parsing issues)
          test -f base_kernel_dtb
          cp base_kernel_dtb kernel_dtb

          # Repack based on original boot header/params
          magiskboot repack boot-base.img
          mv new-boot.img boot-nfc.img

          ls -lah boot-nfc.img
          sha256sum boot-nfc.img | tee boot-nfc.img.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: boot-nfc
          path: |
            boot-nfc.img
            boot-nfc.img.sha256
