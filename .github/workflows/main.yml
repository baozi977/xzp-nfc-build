name: build-kernel-and-repack-boot

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "Kernel git repo URL"
        required: true
        default: "https://github.com/LineageOS/android_kernel_sony_msm8998.git"
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "lineage-22.0"
      defconfig:
        description: "Kernel defconfig name"
        required: true
        default: "lineage_yoshino_defconfig"
      pagesize:
        description: "boot.img pagesize (your boot is 4096)"
        required: true
        default: "4096"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex git libelf-dev libssl-dev \
            python3 unzip zlib1g-dev lz4 ca-certificates file gcc

      # --- Install magiskboot (Magisk 26.4: use libmagiskboot.so as executable) ---
      - name: Install magiskboot
        run: |
          set -eux
          MAGISK_VER="26.4"
          URL="https://github.com/topjohnwu/Magisk/releases/download/v${MAGISK_VER}/Magisk-v${MAGISK_VER}.apk"

          rm -rf magisk_unpack
          mkdir -p magisk_unpack

          curl -fL --retry 5 --retry-delay 2 -o magisk.apk "$URL"
          unzip -q magisk.apk -d magisk_unpack

          MB_SO="magisk_unpack/lib/x86_64/libmagiskboot.so"
          if [ ! -f "$MB_SO" ]; then
            echo "ERROR: $MB_SO not found. Listing:"
            find magisk_unpack -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          chmod +x "$MB_SO"
          sudo cp "$MB_SO" /usr/local/bin/magiskboot
          sudo chmod +x /usr/local/bin/magiskboot
          magiskboot --help | head -n 10 || true

      # --- Build Qualcomm dtbTool (standalone C source, gcc build) ---
      - name: Build dtbTool
        run: |
          set -eux
          git clone --depth=1 https://github.com/rajatgupta1998/android_tools_system_dtbTool.git dtbtool_src
          gcc dtbtool_src/source/dtbtool.c -o dtbTool
          sudo mv dtbTool /usr/local/bin/dtbTool
          /usr/local/bin/dtbTool --help || true

      # --- Build kernel + dtbs using your script ---
      - name: Build kernel (Image.gz + dtbs)
        run: |
          set -eux
          test -f boot.img
          chmod +x ./build_kernel.sh
          ./build_kernel.sh "${{ inputs.kernel_repo }}" "${{ inputs.kernel_branch }}" "${{ inputs.defconfig }}"

          test -f out/Image.gz
          test -d out/dtb
          ls -lah out/Image.gz
          echo "DTB count: $(ls -1 out/dtb | wc -l)"

      # --- Pack kernel_dtb (qcdt) ---
      - name: Pack kernel_dtb (qcdt)
        run: |
          set -eux
          PAGESIZE="${{ inputs.pagesize }}"

          # dtbTool usage differs across implementations. This one expects:
          # dtbTool -o <out> -s <pagesize> -p <dtc_path> <dtb_dir>
          # Some builds accept without -p; we try with -p first, then fallback.

          if [ -d "kernel/scripts/dtc" ]; then
            DTC_PATH="kernel/scripts/dtc/"
          else
            DTC_PATH=""
          fi

          set +e
          /usr/local/bin/dtbTool -o out/kernel_dtb -s "${PAGESIZE}" -p "${DTC_PATH}" out/dtb
          RC=$?
          set -e

          if [ $RC -ne 0 ]; then
            echo "dtbTool with -p failed, retry without -p..."
            /usr/local/bin/dtbTool -o out/kernel_dtb -s "${PAGESIZE}" out/dtb
          fi

          test -f out/kernel_dtb
          ls -lah out/kernel_dtb

      # --- Unpack base boot, replace kernel + kernel_dtb, repack ---
      - name: Repack boot.img with new kernel + dtb
        run: |
          set -eux
          cp boot.img boot-base.img

          magiskboot unpack -h boot-base.img
          magiskboot unpack boot-base.img

          # Your boot is HEADER_VER 0 + separate kernel_dtb -> replace BOTH
          cp out/Image.gz kernel
          cp out/kernel_dtb kernel_dtb

          magiskboot repack boot-base.img
          mv new-boot.img boot-nfc.img

          ls -lah boot-nfc.img
          sha256sum boot-nfc.img | tee boot-nfc.img.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: boot-nfc
          path: |
            boot-nfc.img
            boot-nfc.img.sha256
