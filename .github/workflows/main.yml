name: Build XZP Hybrid Kernel (NFC Fixed)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: Maximize Build Space (æ¸…ç†ç©ºé—´)
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: Install Dependencies (å®‰è£…ç¼–è¯‘å·¥å…·)
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3 python-is-python3

    - name: Install Repo Tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    - name: Initialize Repo (å…³é”®ï¼šæ··åˆç¯å¢ƒé…ç½®)
      run: |
        mkdir lineage
        cd lineage
        
        # 1. åˆå§‹åŒ– Android 15 (LOS 22) ç¯å¢ƒ
        # å¿…é¡»ç”¨ 22.0ï¼Œå¦åˆ™ Ramdisk ç‰ˆæœ¬ä¸å¯¹ï¼Œåˆ·è¿›å»ä¼šå¡æ­»
        repo init -u https://github.com/LineageOS/android.git -b lineage-22.0 --depth=1
        
        # 2. åˆ›å»ºæ¸…å•ï¼šå¼ºåˆ¶ä½¿ç”¨ whatawurst çš„ LOS 21 ä»£ç 
        mkdir -p .repo/local_manifests
        cat <<EOF > .repo/local_manifests/roomservice.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
            <project name="whatawurst/android_kernel_sony_msm8998" path="kernel/sony/msm8998" remote="github" revision="lineage-21" />
            
            <project name="whatawurst/android_device_sony_poplar_kddi" path="device/sony/poplar_kddi" remote="github" revision="lineage-21" />
            
            <project name="LineageOS/android_device_sony_maple" path="device/sony/maple" remote="github" revision="lineage-21" />
            
            <project name="whatawurst/android_vendor_sony_poplar_kddi" path="vendor/sony/poplar_kddi" remote="github" revision="lineage-21" />
            
            <project name="whatawurst/android_device_sony_yoshino-common" path="device/sony/yoshino-common" remote="github" revision="lineage-21" />
            <project name="whatawurst/android_vendor_sony_yoshino-common" path="vendor/sony/yoshino-common" remote="github" revision="lineage-21" />
        </manifest>
        EOF

    - name: Sync Source (åŒæ­¥ä»£ç )
      working-directory: ./lineage
      run: |
        # å…è®¸éƒ¨åˆ†ä»“åº“åŒæ­¥å¤±è´¥ (é˜²æ­¢ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´çš„å¡é¡¿)
        repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags || true

    - name: ğŸŸ¢ Apply Code Adjustments (æ ¸å¿ƒï¼šè°ƒæ•´ä»£ç ï¼)
      working-directory: ./lineage
      run: |
        echo "=== å¼€å§‹è°ƒæ•´ä»£ç ï¼šå¤åˆ» poplar_kddi çš„é€»è¾‘ ==="
        
        # 1. è°ƒæ•´å†…æ ¸é…ç½®ï¼šå¼ºåˆ¶å¼€å¯ Sony CXD224X é©±åŠ¨
        # è·¯å¾„å¯èƒ½å› ç‰ˆæœ¬ç•¥æœ‰ä¸åŒï¼Œå°è¯•ä¸¤ä¸ªå¸¸è§ä½ç½®
        CONFIG_FILE="kernel/sony/msm8998/arch/arm64/configs/lineage_yoshino_defconfig"
        
        if [ -f "$CONFIG_FILE" ]; then
            echo "æ‰¾åˆ°é…ç½®æ–‡ä»¶: $CONFIG_FILE"
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®ï¼Œæ²¡æœ‰åˆ™è¿½åŠ 
            if ! grep -q "CONFIG_SONY_CXD224X=y" "$CONFIG_FILE"; then
                echo "" >> $CONFIG_FILE
                echo "# å¼ºåˆ¶å¼€å¯æ—¥ç‰ˆ NFC é©±åŠ¨" >> $CONFIG_FILE
                echo "CONFIG_SONY_CXD224X=y" >> $CONFIG_FILE
                echo "CONFIG_NFC_PN553=y" >> $CONFIG_FILE
                echo "å·²æ³¨å…¥å†…æ ¸é©±åŠ¨å¼€å…³ï¼"
            fi
        else
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†…æ ¸é…ç½®æ–‡ä»¶ï¼æ— æ³•ä¿®å¤ NFCï¼"
            exit 1
        fi

        # 2. è°ƒæ•´é©±åŠ¨æ–‡ä»¶ï¼šä» poplar_kddi å·æ–‡ä»¶ç»™ maple
        # åˆ›å»º maple ç¼ºå¤±çš„ç›®å½•
        mkdir -p vendor/sony/maple/proprietary/vendor/firmware
        mkdir -p vendor/sony/maple/proprietary/vendor/bin/hw
        mkdir -p vendor/sony/maple/proprietary/vendor/lib64
        
        echo "æ­£åœ¨æ¬è¿é©±åŠ¨..."
        # å¼ºè¡Œè¦†ç›–
        cp -v vendor/sony/poplar_kddi/proprietary/vendor/firmware/libpn553* vendor/sony/maple/proprietary/vendor/firmware/ || true
        cp -v vendor/sony/poplar_kddi/proprietary/vendor/bin/hw/*sony* vendor/sony/maple/proprietary/vendor/bin/hw/ || true
        cp -v vendor/sony/poplar_kddi/proprietary/vendor/lib64/libnfc-nci.conf vendor/sony/maple/proprietary/vendor/lib64/ || true
        
        echo "ä»£ç è°ƒæ•´å®Œæ¯•ï¼å‡†å¤‡ç¼–è¯‘..."

    - name: Build Boot Image (ç¼–è¯‘å†…æ ¸)
      working-directory: ./lineage
      run: |
        source build/envsetup.sh
        
        # å…³é”®å˜é‡ï¼šå…è®¸è·¨ç‰ˆæœ¬ç¼–è¯‘ï¼Œå¿½ç•¥ä¾èµ–ç¼ºå¤±
        export ALLOW_MISSING_DEPENDENCIES=true
        export BUILD_BROKEN_MISSING_REQUIRED_MODULES=true
        export BUILD_BROKEN_ELF_PREBUILT_PRODUCT_COPY_FILES=true
        
        # é€‰æ‹© XZ Premium (maple) ç›®æ ‡
        lunch lineage_maple-userdebug
        
        # åªç¼–è¯‘ bootimage (å«å†…æ ¸ + Ramdisk)
        mka bootimage

    - name: Upload Artifact (ä¸Šä¼ ç»“æœ)
      uses: actions/upload-artifact@v4
      with:
        name: fixed_boot_image_for_los22
        path: lineage/out/target/product/maple/boot.img
