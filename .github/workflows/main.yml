name: build-kernel-and-repack-boot

on:
  workflow_dispatch:
    inputs:
      kernel_ref:
        description: "Kernel ref (branch or tag). Example: lineage-22.0"
        required: true
        default: "lineage-22.0"
      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "lineage_yoshino_defconfig"
      pagesize:
        description: "boot pagesize (yours is 4096)"
        required: true
        default: "4096"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout this repo (boot.img + scripts)
        uses: actions/checkout@v4

      # 关键：用 actions/checkout 把内核仓库拉到 kernel/，避免 git clone 认证提示
      - name: Checkout kernel repo
        uses: actions/checkout@v4
        with:
          repository: LineageOS/android_kernel_sony_msm8998
          ref: ${{ inputs.kernel_ref }}
          path: kernel
          fetch-depth: 1

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex git libelf-dev libssl-dev \
            python3 unzip zlib1g-dev lz4 ca-certificates file gcc

      # --- Install magiskboot (Magisk 26.4: use libmagiskboot.so as executable) ---
      - name: Install magiskboot
        run: |
          set -eux
          MAGISK_VER="26.4"
          URL="https://github.com/topjohnwu/Magisk/releases/download/v${MAGISK_VER}/Magisk-v${MAGISK_VER}.apk"

          rm -rf magisk_unpack
          mkdir -p magisk_unpack
          curl -fL --retry 5 --retry-delay 2 -o magisk.apk "$URL"
          unzip -q magisk.apk -d magisk_unpack

          MB_SO="magisk_unpack/lib/x86_64/libmagiskboot.so"
          test -f "$MB_SO"
          chmod +x "$MB_SO"
          sudo cp "$MB_SO" /usr/local/bin/magiskboot
          sudo chmod +x /usr/local/bin/magiskboot
          magiskboot --help | head -n 10 || true

      # --- Build dtbTool (standalone C source, gcc build) ---
      - name: Build dtbTool
        run: |
          set -eux
          git clone --depth=1 https://github.com/rajatgupta1998/android_tools_system_dtbTool.git dtbtool_src
          gcc dtbtool_src/source/dtbtool.c -o dtbTool
          sudo mv dtbTool /usr/local/bin/dtbTool
          /usr/local/bin/dtbTool --help || true

      # --- Build kernel + dtbs (no cloning here anymore) ---
      - name: Build kernel (Image.gz + dtbs)
        run: |
          set -eux
          test -f boot.img
          test -d kernel
          chmod +x ./build_kernel.sh
          ./build_kernel.sh "${{ inputs.defconfig }}"

          test -f out/Image.gz
          test -d out/dtb
          ls -lah out/Image.gz
          echo "DTB count: $(ls -1 out/dtb | wc -l)"

      - name: Pack kernel_dtb (qcdt)
        run: |
          set -eux
          PAGESIZE="${{ inputs.pagesize }}"
          # 先尝试带 -p（有 dtc 时更稳），失败再退回不带 -p
          if [ -d "kernel/scripts/dtc" ]; then
            DTC_PATH="kernel/scripts/dtc/"
          else
            DTC_PATH=""
          fi

          set +e
          /usr/local/bin/dtbTool -o out/kernel_dtb -s "${PAGESIZE}" -p "${DTC_PATH}" out/dtb
          RC=$?
          set -e

          if [ $RC -ne 0 ]; then
            /usr/local/bin/dtbTool -o out/kernel_dtb -s "${PAGESIZE}" out/dtb
          fi

          test -f out/kernel_dtb
          ls -lah out/kernel_dtb

      - name: Repack boot.img with new kernel + dtb
        run: |
          set -eux
          cp boot.img boot-base.img
          magiskboot unpack -h boot-base.img
          magiskboot unpack boot-base.img

          # HEADER_VER 0 + kernel_dtb 分离 -> 两个都替换
          cp out/Image.gz kernel
          cp out/kernel_dtb kernel_dtb

          magiskboot repack boot-base.img
          mv new-boot.img boot-nfc.img
          ls -lah boot-nfc.img
          sha256sum boot-nfc.img | tee boot-nfc.img.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: boot-nfc
          path: |
            boot-nfc.img
            boot-nfc.img.sha256
