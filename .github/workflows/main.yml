name: Build XZP Hybrid Kernel (NFC Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Maximize Build Space (æ¸…ç†ç©ºé—´)
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 10240
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-codeql: 'true'

    - name: Install Dependencies (å®‰è£…ç¼–è¯‘å·¥å…·)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf \
          imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool \
          libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
          lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          python3 python-is-python3

    - name: Install Repo Tool
      run: |
        mkdir -p ~/bin
        curl -L https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"

    - name: Initialize Repo (å…³é”®ï¼šæ··åˆç¯å¢ƒé…ç½®)
      run: |
        set -e
        mkdir -p lineage
        cd lineage

        echo "== 1) Init LOS 22 env (Android 15) =="
        repo init -u https://github.com/LineageOS/android.git -b lineage-22.0 --depth=1

        echo "== 2) Write local manifest forcing LOS21 device/kernel repos =="
        mkdir -p .repo/local_manifests
        cat > .repo/local_manifests/roomservice.xml <<'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
            <!-- Make sure the remote exists -->
            <remote name="github" fetch="https://github.com/" />

            <!-- Kernel / device trees from LOS21 (legacy sony) -->
            <project name="whatawurst/android_kernel_sony_msm8998"
                     path="kernel/sony/msm8998"
                     remote="github"
                     revision="lineage-21" />

            <project name="LineageOS/android_device_sony_maple"
                     path="device/sony/maple"
                     remote="github"
                     revision="lineage-21" />

            <project name="whatawurst/android_device_sony_yoshino-common"
                     path="device/sony/yoshino-common"
                     remote="github"
                     revision="lineage-21" />

            <!-- ä½ å¦‚æœç¡®å®éœ€è¦ poplar_kddi device treeï¼ˆä»…å‚è€ƒ/æ¯”å¯¹ï¼‰ï¼Œä¿ç•™ä¹Ÿè¡Œ -->
            <project name="whatawurst/android_device_sony_poplar_kddi"
                     path="device/sony/poplar_kddi"
                     remote="github"
                     revision="lineage-21" />
        </manifest>
        EOF

        echo "== Local manifest content =="
        cat .repo/local_manifests/roomservice.xml

    - name: Sync Source (åŒæ­¥ä»£ç ï¼Œå¤±è´¥ä¸å)
      working-directory: ./lineage
      run: |
        set -e
        echo "== repo sync (1st try) =="
        repo sync -c -j"$(nproc)" --force-sync --no-clone-bundle --no-tags
        echo "== repo sync done =="

    - name: ğŸŸ¢ Apply Code Adjustments (æ ¸å¿ƒï¼šè°ƒæ•´ defconfig)
      working-directory: ./lineage
      run: |
        set -euo pipefail

        echo "=== å¼€å§‹è°ƒæ•´å†…æ ¸ defconfig ==="

        # defconfig å¸¸è§å€™é€‰è·¯å¾„ï¼ˆä¸åŒæ ‘å¯èƒ½ç•¥æœ‰å˜åŒ–ï¼‰
        CANDIDATES=(
          "kernel/sony/msm8998/arch/arm64/configs/lineage_yoshino_defconfig"
          "kernel/sony/msm8998/arch/arm64/configs/yoshino_defconfig"
          "kernel/sony/msm8998/arch/arm64/configs/lineage_defconfig"
        )

        CONFIG_FILE=""
        for f in "${CANDIDATES[@]}"; do
          if [ -f "$f" ]; then
            CONFIG_FILE="$f"
            break
          fi
        done

        if [ -z "$CONFIG_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° defconfig æ–‡ä»¶ï¼ä¸‹é¢åˆ—å‡º configs ç›®å½•ï¼š"
          ls -la kernel/sony/msm8998/arch/arm64/configs || true
          exit 1
        fi

        echo "âœ… ä½¿ç”¨ defconfig: $CONFIG_FILE"

        set_kcfg() {
          local key="$1" val="$2" file="$3"
          if grep -qE "^${key}=" "$file"; then
            sed -i "s/^${key}=.*/${key}=${val}/" "$file"
          else
            echo "${key}=${val}" >> "$file"
          fi
        }

        echo "== å¼ºåˆ¶å¯ç”¨ Sony CXD224X =="
        set_kcfg CONFIG_SONY_CXD224X y "$CONFIG_FILE"

        echo "== ä¸ºé¿å…å†²çªï¼Œå…ˆç¦ç”¨ NXP PN553 =="
        # ï¼ˆä½ ä¹‹å‰å†™æˆ y äº†ï¼Œè¿™é‡Œæ”¹ä¸º nï¼‰
        set_kcfg CONFIG_NFC_PN553 n "$CONFIG_FILE"

        echo "== ä¿®æ”¹ç»“æœï¼ˆdefconfig ç‰‡æ®µï¼‰=="
        grep -nE "CONFIG_SONY_CXD224X=|CONFIG_NFC_PN553=" "$CONFIG_FILE" || true

    - name: Build Boot Image (ç¼–è¯‘ bootimage)
      working-directory: ./lineage
      run: |
        set -euo pipefail

        source build/envsetup.sh

        # å…è®¸è·¨ç‰ˆæœ¬ç¼–è¯‘/ç¼ºå¤±ä¾èµ–ï¼ˆä½ åŸæœ¬å°±è¿™ä¹ˆåšï¼‰
        export ALLOW_MISSING_DEPENDENCIES=true
        export BUILD_BROKEN_MISSING_REQUIRED_MODULES=true
        export BUILD_BROKEN_ELF_PREBUILT_PRODUCT_COPY_FILES=true

        lunch lineage_maple-userdebug

        # ç¼–è¯‘ bootimage (å†…æ ¸ + ramdisk)
        mka bootimage

        echo "=== ç¼–è¯‘å®Œæˆï¼šéªŒè¯æœ€ç»ˆ kernel .config æ˜¯å¦çœŸçš„ç”Ÿæ•ˆ ==="
        KCFG="out/target/product/maple/obj/KERNEL_OBJ/.config"
        if [ -f "$KCFG" ]; then
          echo "âœ… æ‰¾åˆ°æœ€ç»ˆ .config: $KCFG"
          grep -nE "CONFIG_SONY_CXD224X=|CONFIG_NFC_PN553=" "$KCFG" || true
        else
          echo "âš ï¸ æœªæ‰¾åˆ° $KCFGï¼ˆä¸åŒå†…æ ¸æ„å»ºç³»ç»Ÿå¯èƒ½è·¯å¾„ä¸åŒï¼‰"
          echo "å°è¯•æœç´¢ .configï¼š"
          find out -maxdepth 6 -name ".config" -type f | head -n 20 || true
        fi

        echo "=== boot.img è¾“å‡ºæ£€æŸ¥ ==="
        ls -la out/target/product/maple/boot.img

    - name: Upload Artifact (ä¸Šä¼  boot.img)
      uses: actions/upload-artifact@v4
      with:
        name: fixed_boot_image_for_los22
        path: lineage/out/target/product/maple/boot.img
