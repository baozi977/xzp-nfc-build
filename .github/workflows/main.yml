name: build-kernel-and-repack-boot

on:
  workflow_dispatch:
    inputs:
      kernel_repo:
        description: "Kernel git repo URL"
        required: true
        default: "https://github.com/whatawurst/android_kernel_sony_msm8998.git"
      kernel_branch:
        description: "Preferred kernel branch (will auto-fallback if not found)"
        required: true
        default: "lineage-22.0"
      defconfig:
        description: "Kernel defconfig name (will auto-fallback if not found)"
        required: true
        default: "lineage_yoshino_defconfig"
      pagesize:
        description: "boot.img pagesize (your boot is 4096)"
        required: true
        default: "4096"
      magisk_ver:
        description: "Magisk version to extract magiskboot from"
        required: true
        default: "26.4"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            bc bison build-essential ccache curl flex git libelf-dev libssl-dev \
            python3 unzip zlib1g-dev lz4 ca-certificates file gcc

      # ---- Install magiskboot (Magisk 26.x: use libmagiskboot.so as executable) ----
      - name: Install magiskboot
        run: |
          set -eux
          MAGISK_VER="${{ inputs.magisk_ver }}"
          URL="https://github.com/topjohnwu/Magisk/releases/download/v${MAGISK_VER}/Magisk-v${MAGISK_VER}.apk"

          rm -rf magisk_unpack
          mkdir -p magisk_unpack

          curl -fL --retry 5 --retry-delay 2 -o magisk.apk "$URL"
          unzip -q magisk.apk -d magisk_unpack

          MB_SO="magisk_unpack/lib/x86_64/libmagiskboot.so"
          if [ ! -f "$MB_SO" ]; then
            echo "x86_64 lib not found, search any libmagiskboot.so..."
            MB_SO="$(find magisk_unpack -type f -name 'libmagiskboot.so' -print | head -n 1 || true)"
          fi
          if [ -z "$MB_SO" ] || [ ! -f "$MB_SO" ]; then
            echo "ERROR: libmagiskboot.so not found. Listing:"
            find magisk_unpack -maxdepth 4 -type f | head -n 200
            exit 1
          fi

          chmod +x "$MB_SO"
          sudo cp "$MB_SO" /usr/local/bin/magiskboot
          sudo chmod +x /usr/local/bin/magiskboot
          magiskboot --help | head -n 15 || true

      # ---- Build standalone dtbTool (C source, gcc build) ----
      - name: Build dtbTool
        run: |
          set -eux
          git clone --depth=1 https://github.com/rajatgupta1998/android_tools_system_dtbTool.git dtbtool_src
          gcc dtbtool_src/source/dtbtool.c -o dtbTool
          sudo mv dtbTool /usr/local/bin/dtbTool
          /usr/local/bin/dtbTool --help || true

      # ---- Detect available kernel branch (fallback) ----
      - name: Select kernel branch (auto fallback)
        id: pick_branch
        run: |
          set -eux
          REPO="${{ inputs.kernel_repo }}"
          PREFERRED="${{ inputs.kernel_branch }}"

          echo "Checking heads from: $REPO"
          git ls-remote --heads "$REPO" | head -n 30 || true

          pick() {
            b="$1"
            if git ls-remote --heads "$REPO" "refs/heads/$b" | grep -q "refs/heads/$b"; then
              echo "$b"
              return 0
            fi
            return 1
          }

          # Try preferred first, then common fallbacks
          for b in "$PREFERRED" lineage-22 lineage-21.0 lineage-21 lineage-20.0 lineage-20 lineage-19.1 lineage-19; do
            if pick "$b" >/dev/null; then
              echo "branch=$b" >> "$GITHUB_OUTPUT"
              echo "Selected branch: $b"
              exit 0
            fi
          done

          echo "ERROR: No suitable branch found on $REPO"
          exit 1

      # ---- Build kernel (uses your build_kernel.sh) ----
      - name: Build kernel (Image.gz + dtbs)
        env:
          # Optional: if you want to use token, set repo secret:
          # KERNEL_GITHUB_TOKEN
          KERNEL_GITHUB_TOKEN: ${{ secrets.KERNEL_GITHUB_TOKEN }}
        run: |
          set -eux
          test -f boot.img
          test -f ./build_kernel.sh
          chmod +x ./build_kernel.sh

          ./build_kernel.sh "${{ inputs.kernel_repo }}" "${{ steps.pick_branch.outputs.branch }}" "${{ inputs.defconfig }}"

          test -f out/Image.gz
          test -d out/dtb
          ls -lah out/Image.gz
          echo "DTB count: $(ls -1 out/dtb | wc -l)"

      # ---- Pack kernel_dtb blob for boot header v0 ----
      - name: Pack kernel_dtb (qcdt)
        run: |
          set -eux
          PAGESIZE="${{ inputs.pagesize }}"

          set +e
          /usr/local/bin/dtbTool -o out/kernel_dtb -s "${PAGESIZE}" out/dtb
          RC=$?
          set -e
          if [ $RC -ne 0 ]; then
            echo "dtbTool simple mode failed, retry with -p kernel/scripts/dtc/ if present..."
            if [ -d "kernel/scripts/dtc" ]; then
              /usr/local/bin/dtbTool -o out/kernel_dtb -s "${PAGESIZE}" -p kernel/scripts/dtc/ out/dtb
            else
              echo "No kernel/scripts/dtc; cannot use -p mode."
              exit 1
            fi
          fi

          test -f out/kernel_dtb
          ls -lah out/kernel_dtb

      # ---- Repack base boot: replace kernel + kernel_dtb ----
      - name: Repack boot.img with new kernel + dtb
        run: |
          set -eux
          cp boot.img boot-base.img

          magiskboot unpack -h boot-base.img
          magiskboot unpack boot-base.img

          # HEADER_VER 0 + separate kernel_dtb -> replace BOTH
          cp out/Image.gz kernel
          cp out/kernel_dtb kernel_dtb

          magiskboot repack boot-base.img
          mv new-boot.img boot-nfc.img

          ls -lah boot-nfc.img
          sha256sum boot-nfc.img | tee boot-nfc.img.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: boot-nfc
          path: |
            boot-nfc.img
            boot-nfc.img.sha256
